---
title: "Sorites Model Results"
author: "Erin Bennett"
header-includes:
   - \usepackage{tikz}
   - \usetikzlibrary{bayesnet}
output: html_document
---

```{r global_options, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = F, warning = F, cache = F, message = F,
                      sanitiz = F, fig.width = 5, fig.height = 3)
```

```{r load_experiment_data_and_libraries, message=F, warning=F}
source("utils.R")
source("reformatting_data.R")
source("plot_model_results.R")
df = load_sorites()
give_a_number = load_give_a_number() %>%
  mutate(src = "data")
prior_bins = load_priors()
```


## Discretization

As discussed in `data_summary.html`, there were different prices used in the designs for different experiments. Since the range of prices is so wide, and since some prices are very close together, it would be difficult to create a discretization that works for every dollar amount used across all experiments. Because of this, I have implemented a separate discretization for each experiment.

The discretization works by creating a set of bins (not necessarily of equal width) such that each price in the experiment falls into a unique bin. There must also be bins below the lowest price's bin and above the highest price's bin. The probability of each bin is computed from the cdf: `prob_bin = pnorm(upper_boundary) - pnorm(lower_boundary)`. The probability of theta falling between prices from adjacent bins depends on the widths of those bins (and also the cdf, but I'm ignoring that for now).

Here's the discretization used for the full set of sorites experiments.

Bins are shown divided by vertical lines. The midpoints of the bins, used as the value, appear in black. The thetas, which appear at the boundaries of the bins, are shown in grey. The height of the bars represent the probability that theta will fall between each pair of midpoints.

```{r discretization, fig.width=10, fig.height=2}
print(plot_bins("all"))
```

## Likert responses

For a linking function from S1 endorsement probabilities to Likert scale responses, I use a binomial with parameter equal to the endorsement probability. So for endorsement probability 0.7, the expected distribution of Likert responses would be

```{r likert, fig.width=3, fig.height=1.75}
expand.grid(e = seq(0.1, 0.9, 0.1),
            r = seq(0, 9, 1)) %>%
  mutate(p = dbinom(r, 9, e)) %>%
  filter(abs(e - 0.7) < 0.001) %>%
  ggplot() +
  aes(x=r, y=p) +
  ylab("probability") +
  xlab("response") +
  # facet_wrap(~e) +
  geom_bar(stat="identity")
```

## Model fit: Final Design

### Old version

In Noah's slides, we show model fit for only the final prior elicitaiton and the final sorites design (relative clause, with the final set of ranges). In the past, we fit the price prior parameters in R and then did a course grid search for speakerOptimality. We used the joint posterior distribution over the price $x$ and the threshold $\theta$ from listener1 (the pragmatic listener) to get model predictions for both sorites premises. For inductive, we took the proportion of the model samples where $x-\varepsilon > \theta$. For concrete, we took the proportion of the model samples where $given\ price > \theta$. We z-scored participants' responses for the correlation plots.

### BDA version

We can reproduce the old results from Noah's slides with our new `webppl` implementation with Bayesiean data analysis. We can simultaneously fit participants' bin ratings from the final prior elicitation and their responses for the final version of the sorites premises study.

```{r}
reproduce_old_plots = plot_sorites(
  "../models/results/results-S1-sigmax10_10000_burn5000_lag20_chain001_concrete_inductive_bins_12_11_listener0_normed_rating_ignore_last_bin.csv",
  zscore = T,
  all_experiments = F
)
```

```{r, fig.width=15, fig.height=6}
print(reproduce_old_plots$final_sorites_curves)
```

```{r, fig.width=10, fig.height=4}
print(reproduce_old_plots$final_sorites_cor)
```

Fitting to the final sorites *and* bins data does not significantly change the inferred priors relative to fitting only to the bins data. That is, the prior fits are being driven by the bins data and the concrete and inductive premise data mostly affect the optimality parameter. Since this is exactly how I used that information in the old version, it makes sense that we reproduce the results even with the BDA.

```{r, fig.width=15, fig.height=3}
print(reproduce_old_plots$final_prior_ecdf)
```

If we only give the model data from the final bins prior elicitation, the model has high uncertainty about the concrete premise, but has a decent correlation with the data.

```{r}
fit_to_final_bins_only = plot_sorites(
  "../models/results/results-S1-sigmax10_10000_burn5000_lag20_chain001_bins_12_11_listener0_normed_rating_ignore_last_bin.csv",
  zscore = F,
  all_experiments = F
)
```

```{r, fig.width=10, fig.height=4}
fit_to_final_bins_only$final_sorites_cor
```

```{r, fig.width=10, fig.height=2}
# sanity check: yes, when we fit to bins only, the cor with bins is high
# print(fit_to_final_bins_only$final_prior_ecdf)
```

However, the priors on prices we would infer from the sorites responses alone are quite different from both the give-a-number priors and the final experiment bins priors.

```{r}
fit_to_final_sorites_only = plot_sorites(
  "../models/results/results-S1-sigmax10_10000_burn5000_lag20_chain001_concrete_inductive_12_11_listener0_normed_rating_ignore_last_bin.csv",
  zscore = F,
  all_experiments = F
)
```

```{r, fig.width=10, fig.height=2}
print(fit_to_final_sorites_only$giveanumber_ecdf)
print(fit_to_final_sorites_only$final_prior_ecdf)
```

In this situation, when we just fit the priors to the sorites data, the model can "explain" a lot of the variance, but it's likely overfitting to this particular dataset. I haven't tried to predict held-out data, which would show how much overfitting is happening here.

```{r, fig.width=10, fig.height=4}
fit_to_final_sorites_only$final_sorites_cor
```

## Model fit: All Designs

```{r}
# fit_to_all_sorites_no_bins = plot_sorites(
#   "../models/results/results-S1-sigmax10_10000_burn5000_lag20_chain001_concrete_inductive_12_allsorites_listener0_normed_rating_ignore_last_bin.csv",
#   zscore = F,
#   all_experiments = F
# )
```

```{r}
# fit_to_all_sorites_and_bins = plot_sorites(
#   "../models/results/",
#   zscore = F,
#   all_experiments = F
# )
```

```{r}
fit_to_all_bins_no_sorites = plot_sorites(
  "../models/results/results-S1-sigmax10_10000_burn5000_lag20_chain001_bins_allbins_allsorites_listener0_normed_rating_ignore_last_bin.csv",
  zscore = F,
  all_experiments = F
)
```

```{r, fig.width=10, fig.height=4}
fit_to_all_bins_no_sorites$final_sorites_cor
```


## Checks of convergence

### Final experiments, fitting everything at once

```{r, fig.width=10, fig.height=6}
reproduce_old_plots$raw_model_output %>%
  filter(result_type == "price_prior") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(specifics ~ object, scales="free") +
  ggtitle("inferred prior price params - reproduced (fit all final experiments")
```

```{r, fig.width=4, fig.height=2}
reproduce_old_plots$raw_model_output %>%
  filter(result_type == "global_param") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(~specifics, scales="free") +
  ggtitle("inferred global params - reproduced (fit all final experiments")
```

```{r, fig.width=15, fig.height=17}
reproduce_old_plots$raw_model_output %>%
  change_names(c("result_type", "dollar_amount",
                "expt_id", "object",
                "value", "probability")) %>%
  filter(result_type == "Inductive") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(dollar_amount~object, ncol = 5, scales="free") +
  ggtitle("inferred inductive - reproduced (fit all final experiments")
```

```{r, fig.width=15, fig.height=17}
reproduce_old_plots$raw_model_output %>%
  change_names(c("result_type", "dollar_amount",
                "expt_id", "object",
                "value", "probability")) %>%
  filter(result_type == "S1") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(dollar_amount~object, ncol = 5, scales="free") +
  ggtitle("inferred concrete - reproduced (fit all final experiments")
```

### Final experiments, fitting bins only


```{r, fig.width=10, fig.height=6}
fit_to_final_bins_only$raw_model_output %>%
  filter(result_type == "price_prior") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(specifics ~ object, scales="free") +
  ggtitle("inferred prior price params - final bins")
```

```{r, fig.width=4, fig.height=2}
fit_to_final_bins_only$raw_model_output %>%
  filter(result_type == "global_param") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(~specifics, scales="free") +
  ggtitle("inferred global params - final bins")
```

```{r}
# fit_to_final_bins_only$raw_model_output %>%
#   filter(result_type == "global_param") %>%
#   filter(specifics == "sigbin")
```


```{r, fig.width=15, fig.height=17}
fit_to_final_bins_only$raw_model_output %>%
  change_names(c("result_type", "dollar_amount",
                "expt_id", "object",
                "value", "probability")) %>%
  filter(result_type == "Inductive") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(dollar_amount~object, ncol = 5, scales="free") +
  ggtitle("inferred inductive - final bins")
```

```{r, fig.width=15, fig.height=17}
fit_to_final_bins_only$raw_model_output %>%
  change_names(c("result_type", "dollar_amount",
                "expt_id", "object",
                "value", "probability")) %>%
  filter(result_type == "S1") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(dollar_amount~object, ncol = 5, scales="free") +
  ggtitle("inferred concrete - final bins")
```


### Final experiments, fitting sorites only


```{r, fig.width=10, fig.height=6}
fit_to_final_sorites_only$raw_model_output %>%
  filter(result_type == "price_prior") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(specifics ~ object, scales="free") +
  ggtitle("inferred prior price params - final sorites")
```

```{r, fig.width=4, fig.height=2}
fit_to_final_sorites_only$raw_model_output %>%
  filter(result_type == "global_param") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(~specifics, scales="free") +
  ggtitle("inferred global params - final sorites")
```

```{r, fig.width=15, fig.height=17}
fit_to_final_sorites_only$raw_model_output %>%
  change_names(c("result_type", "dollar_amount",
                "expt_id", "object",
                "value", "probability")) %>%
  filter(result_type == "Inductive") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(dollar_amount~object, ncol = 5, scales="free") +
  ggtitle("inferred inductive - final sorites")
```

```{r, fig.width=15, fig.height=17}
fit_to_final_sorites_only$raw_model_output %>%
  change_names(c("result_type", "dollar_amount",
                "expt_id", "object",
                "value", "probability")) %>%
  filter(result_type == "S1") %>%
  ggplot(aes(x=value)) +
  geom_histogram(bins=50) +
  facet_wrap(dollar_amount~object, ncol = 5, scales="free") +
  ggtitle("inferred concrete - final sorites")
```
