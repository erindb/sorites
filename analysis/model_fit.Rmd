---
title: "Sorites Data Summary"
author: "Erin Bennett"
header-includes:
   - \usepackage{tikz}
   - \usetikzlibrary{bayesnet}
output: html_document
---

```{r global_options, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = F, warning = F, cache = F, message = F,
                      sanitiz = F, fig.width = 5, fig.height = 3)
```

```{r}
source("utils.R")
source("reformatting_data.R")
df = load_sorites()
give_a_number = load_give_a_number() %>%
  mutate(src = "data")
df %>% filter(id=="07c", qtype=="concrete") %>%
  .$object %>%
  unique
range(df$response)
```

Bins are shown divided by vertical lines. The midpoints of the bins, used as the value, appear in black. The thetas, which appear at the boundaries of the bins, are shown in grey. The height of the bars represent the probability that theta will fall between each pair of midpoints.

```{r}
rename_list = function(lst, name, new_name) {
  lst[[new_name]] = lst[[name]]
  lst[[name]] = NULL
  return(lst)
}
bins = RJSONIO::fromJSON("../models/results/bins_07c.json") %>%
  rename_list("coffee maker", "coffee_maker") %>%
  as.data.frame() %>%
  gather() %>%
  separate(key, c("object", "variable"), sep="\\.") %>%
  group_by(object, variable) %>%
  mutate(bin_number = 1:length(value)) %>%
  spread(variable, value)
theta_bins = bins %>%
  select(object, mid, theta_prob) %>%
  rename(upper_theta = mid) %>%
  mutate(lower_theta = c(0, upper_theta[1:(length(upper_theta)-1)])) %>%
  gather("var", "theta", c(upper_theta, lower_theta)) %>%
  select(-var)
bins %>%
  ggplot() +
  geom_point(aes(x=mid, y=0)) +
  geom_point(aes(x=theta, y=theta_prob), alpha=0.2) +
  geom_vline(aes(xintercept=lower), alpha=0.2) +
  geom_ribbon(data=theta_bins, aes(x=theta, ymin=0, ymax=theta_prob), alpha=0.2) +
  facet_wrap(~object, scales="free")
```

Linking function for likert scale will be binomial with parameter equal to the endorsement probability.

```{r}
#likert
expand.grid(e = seq(0.1, 0.9, 0.1),
            r = seq(0, 9, 1)) %>%
  mutate(p = dbinom(r, 9, e)) %>%
  ggplot() +
  aes(x=r, y=p) +
  facet_wrap(~e) +
  geom_bar(stat="identity")
```


```{r, fig.height=2, fig.width=10}
give_a_number %>%
  ggplot() +
  aes(x=price, color=src) +
  stat_ecdf(geom="step") +
  facet_wrap(~object, scales="free", ncol=5) +
  scale_colour_solarized()
```

```{r}
model_results_file = "../models/results/results-genint-S1-endorsePrediction-int6-prior3-3Components_5000_burn2500_lag10_chain1.csv"
rs = read.csv(model_results_file,
              col.names = c("result_type", "variable",
                            "result_category", "object",
                            "value", "probability")) %>%
  filter(result_category == "price_prior") %>%
  group_by(result_type, variable, result_category, object) %>%
  mutate(sample = 1:length(value)) %>%
  ungroup()
```

```{r, fig.height=4, fig.width=10}
rs %>%
  ggplot() +
  aes(x=value) +
  geom_histogram(bins=30) +
  facet_wrap(variable~object, ncol = 5, scales = "free")
```


```{r}
posterior_prices = rs %>%
  filter(result_type == "param",
         result_category == "price_prior") %>%
  spread(variable, value) %>%
  rowwise() %>%
  mutate(price = rlnorm(1, mean=mu, sd = sigma),
         src = "model")
```

```{r, fig.height=2, fig.width=11}
posterior_prices %>%
  mutate(object = char(object)) %>%
  select(price, object, src) %>%
  rbind(give_a_number %>%
          mutate(object = char(object))) %>%
  group_by(object, src) %>%
  filter(price < quantile(price, 0.95)) %>%
  ungroup() %>%
  ggplot() +
  aes(x=price, color=src) +
  stat_ecdf(geom="step", size=1) +
  facet_wrap(~object, scales="free", ncol=5) +
  scale_colour_solarized()
ggsave("posterior_prices.pdf", width=20, height=4)
```

```{r, fig.height=3, fig.width=10}
df %>%
  filter(qtype=="concrete",
         id=="07c") %>%
  ggplot() +
  aes(x=dollar_amount, y=response) +
  geom_point(alpha=0.05) +
  stat_summary(fun.data = mean_cl_boot, geom="pointrange") +
  facet_wrap(~object, scales="free", ncol = 5)
```


```{r}
model_results_file = "../models/results/results-genint-S1-endorsePrediction-int6-prior3-3Components_5000_burn2500_lag10_chain3.csv"
rs = read.csv(model_results_file,
              col.names = c("result_type", "dollar_amount",
                            "result_category", "object",
                            "value", "probability")) %>%
  filter(result_category == "S1") %>%
  group_by(result_type, dollar_amount, result_category, object) %>%
  mutate(sample = 1:length(value)) %>%
  ungroup() %>%
  mutate(dollar_amount = num(dollar_amount))

get_expectation = function(values, probabilities) {
  return(data.frame(y=mu, ymin=mu, ymax=mu))
}
expectation = rs %>%
  group_by(dollar_amount, object) %>%
  do(get_expectation(.$value, .$probability)) %>%
  mutate(src="model") %>%
  rbind(df %>%
          filter(qtype=="concrete",
                 id=="07c") %>%
          group_by(dollar_amount, object) %>%
          do(mean_cl_boot(.$response)) %>%
          mutate(src="data")) %>%
  gather(variable, value, -c(dollar_amount, object, src)) %>%
  unite(tmp, src, variable) %>%
  spread(tmp, value) %>%
  mutate(price = factor(dollar_amount))
expectation %>%
  ggplot() +
  aes(x=model_y,
      y=data_y, ymin=data_ymin, ymax=data_ymax,
      colour=price) +
  # geom_abline(slope = 1, intercept = 0, alpha=0.2) +
  geom_pointrange() +
  scale_color_solarized()
```

