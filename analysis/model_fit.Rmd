---
title: "Sorites Data Summary"
author: "Erin Bennett"
header-includes:
   - \usepackage{tikz}
   - \usetikzlibrary{bayesnet}
output: html_document
---

```{r global_options, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = F, warning = F, cache = F, message = F,
                      sanitiz = F, fig.width = 5, fig.height = 3)
```

```{r}
source("utils.R")
source("reformatting_data.R")
df = load_sorites()
give_a_number = load_give_a_number() %>%
  mutate(src = "data")
df %>% filter(id=="07c", qtype=="concrete") %>%
  .$object %>%
  unique
```

Bins are shown divided by vertical lines. The midpoints of the bins, used as the value, appear in black. The thetas, which appear at the boundaries of the bins, are shown in grey. The height of the bars represent the probability that theta will fall between each pair of midpoints.

```{r}
library(rjson)
rename_list = function(lst, name, new_name) {
  lst[[new_name]] = lst[[name]]
  lst[[name]] = NULL
  return(lst)
}
bins = fromJSON("../models/results/bins_07c.json") %>%
  rename_list("coffee maker", "coffee_maker") %>%
  as.data.frame() %>%
  gather() %>%
  separate(key, c("object", "variable"), sep="\\.") %>%
  group_by(object, variable) %>%
  mutate(bin_number = 1:length(value)) %>%
  spread(variable, value)
theta_bins = bins %>%
  select(object, mid, theta_prob) %>%
  rename(upper_theta = mid) %>%
  mutate(lower_theta = c(0, upper_theta[1:(length(upper_theta)-1)])) %>%
  gather("var", "theta", c(upper_theta, lower_theta)) %>%
  select(-var)
bins %>%
  ggplot() +
  geom_point(aes(x=mid, y=0)) +
  geom_point(aes(x=theta, y=theta_prob), alpha=0.2) +
  geom_vline(aes(xintercept=lower), alpha=0.2) +
  geom_ribbon(data=theta_bins, aes(x=theta, ymin=0, ymax=theta_prob), alpha=0.2) +
  facet_wrap(~object, scales="free")
```


```{r, fig.height=1, fig.width=5}
give_a_number %>%
  ggplot() +
  aes(x=price, color=src) +
  stat_ecdf(geom="step") +
  facet_wrap(~object, scales="free", ncol=5) +
  scale_colour_solarized()
```

```{r}
model_results_file = "../models/results/results-genint-S1-endorsePrediction-int6-prior3-3Components_5000_burn2500_lag10_chain1.csv"
rs = read.csv(model_results_file,
              col.names = c("result_type", "variable",
                            "result_category", "object",
                            "value", "probability"))
```

There's a problem with these parameter histograms, I think. They're bimodal and they didn't use to be in the previous version of the model.

```{r}
rs %>%
  ggplot() +
  aes(x=value) +
  geom_histogram() +
  facet_wrap(~object, scales = "free")
```


```{r}
rs %>%
  filter(result_type == "param",
         result_category == "price_prior") %>%
  spread(label, value) %>%
  rowwise() %>%
  mutate(log_price = rnorm(1, mean = mu, sd = sigma),
         price = exp(log_price),
         src = "model")
```

```{r}
rs %>% %>%
```


