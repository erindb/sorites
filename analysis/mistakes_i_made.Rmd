---
title: "Mistakes I made"
author: "Erin Bennett"
date: "10/3/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("utils.R")
```

## Log-normal Density function

I am a silly person.

The Log-normal cdf evaluated at $x$ is the same as the Normal cdf evaluated at $log(x)$. But the *density* function for Log-normal is *not* the same as the desnity function for Normal evaluated at $log(x)$.

The density function is the derivative of the cdf. So the chain rule applies.

$$f(x) = \frac{d}{dx}\Phi(\log(x)) = \Phi'(\log(x)) \cdot \frac{d}{dx}\log(x) = \varphi(\log(x)) \cdot \frac{d}{dx}\log(x)$$

Spelling this out even further, for any given change in $x$, there's a corresponding change in $log(x)$. If the Log-normal density were just the Normal density of the log, then the probability *mass* corresponding to a given change in $x$ would be different than the probability mass for that *same* change in $log(x)$. And that is not how things work. Here's the correct (black) and incorrect (red) density functions (rescaled so their max density is the same, so we can see them both):

```{r, fig.width=3, echo=F, fig.height=2}
max_value = 10
x = seq(0, max_value, 0.01)
px2 = dnorm(log(x))
px = dlnorm(x)
df_max = max(px)
df2_max = max(px2)
px = df2_max/df_max * px
ggplot() +
  geom_line(aes(x=x, y=px)) +
  geom_line(aes(x=x, y=px2), colour="red") +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())
```

So, given the params $\mu$ and $\sigma$ (in log space) of the Log-normal distribution, the density function would be:

$$\varphi\left(\frac{\log(x) - \mu}{\sigma}\right)\frac{1}{\sigma x}$$

or

$$\frac{1}{x} \cdot \frac{1}{\sigma\sqrt{2\pi}} \cdot \exp\left(-\frac{(\log(x) - \mu)^2}{2\sigma^2}\right)$$
And so the score is

\begin{aligned}

\log\left( \frac{1}{x} \cdot \frac{1}{\sigma\sqrt{2\pi}} \exp\left(-\frac{(\log(x) - \mu)^2}{2\sigma^2}\right) \right) &=

\log(\frac{1}{x}) + \log(\frac{1}{\sigma\sqrt{2\pi}}) -\frac{(\log(x) - \mu)^2}{2\sigma^2} =   \\

&= -\log(x) - \log(\sigma) - \frac{1}{2}\log((2\pi)) - \frac{(\log(x) - \mu)^2}{2\sigma^2}

\end{aligned}
