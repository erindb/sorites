---
title: "Sorites Data Summary"
author: "Erin Bennett"
output: "pdf_document"
---

```{r global_options, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo=F, warning=F, cache=F, message=F, sanitiz=F, fig.width = 5, fig.height = 3)
```

```{r load libraries}
source("~/Settings/startup.R")
library(knitr)
library(pander)
```

# Wording used in sorites experiments

```{r load design descriptions}
sorites_designs = read.csv("data/sorites/sorites_designs.csv",
                           stringsAsFactors = F)
sorites_designs %>%
  select(-prompt, -left, -right, -concrete, -inductive) %>%
  rename(`inductive phrasing` = inductive_label) %>%
  pander(.,
       caption="Sorites variations",
       align=rep("l", ncol(sorites_designs)))
lookup_phrasing = function(inductive_phrasing) {
  return((
    sorites_designs %>%
      filter(inductive_label==inductive_phrasing)
  )$inductive[[1]])
}
```

Possible phrasings of inductive premise:

* relative: "`r lookup_phrasing("relative")`"
* conditional: "`r lookup_phrasing("conditional")`"

Consistent across all experiments:

* Concrete premise: "`r sorites_designs$concrete[[1]]`"
* Prompt: "`r sorites_designs$prompt[[1]]`"
* Left (lower) label of likert scale: "`r sorites_designs$left[[1]]`""
* Right (higher) label of likert scale: "`r sorites_designs$right[[1]]`""

*In experiments 7a and 7b, phrasing was randomized between participants (either relative or conditional), but I did not record which phrasing was used for which participant

# Results of sorites experiments

```{r load (and reformat) data}
## this is the script for reformatting sorites data into one single datafile
RUN_REFORMAT = F
if (RUN_REFORMAT) {
  lookup_date = function(experiment_id) {
    return((
      sorites_designs %>%
        filter(char(id)==experiment_id)
    )$date[[1]])
  }
  find_sorites_filename = function(experiment_id) {
    directory = "data/sorites/"
    filenames = list.files(directory)
    filename = filenames[
      grep(paste("data_exp", experiment_id, sep=""),
           filenames)
      ]
    return(paste(directory, filename, sep=""))
  }
  read_sorites_data = function(experiment_id) {
    raw_df_all_columns = read.csv(
      find_sorites_filename(experiment_id),
      stringsAsFactors = F
    )
    
    ## for experiment 10 data format:
    if ("Answer.responses" %in% names(raw_df_all_columns)) {
      raw_df_all_columns$Answer.questions = raw_df_all_columns$Answer.responses
    }
    if (!("Answer.phrasing" %in% names(raw_df_all_columns))) {
      raw_df_all_columns$Answer.phrasing = NA
    }
    if ("Answer.time_in_minutes" %in% names(raw_df_all_columns)) {
      raw_df_all_columns$time_in_minutes = raw_df_all_columns$Answer.time_in_minutes
    } else {
      raw_df_all_columns$time_in_minutes = NA
    }
    if ("Answer.subj_data" %in% names(raw_df_all_columns)) {
      subj_data = do.call(rbind, lapply(raw_df_all_columns$Answer.subj_data, fromJSON)) %>%
        as.data.frame
      raw_df_all_columns$Answer.comments = unlist(subj_data$comments)
      raw_df_all_columns$Answer.language = unlist(subj_data$language)
      raw_df_all_columns$Answer.education = unlist(subj_data$education)
      raw_df_all_columns$Answer.age = unlist(subj_data$age)
    } else {
      raw_df_all_columns$Answer.education = NA
    }
    
    ## select only the useful columns
    raw_df = raw_df_all_columns %>%
      rename(comments = Answer.comments,
             language = Answer.language,
             questions = Answer.questions,
             education = Answer.education,
             phrasing = Answer.phrasing,
             age = Answer.age) %>%
      select(workerid, reward, comments,
             age, language, questions) %>%
      mutate(workerid = paste(workerid, experiment_id, sep="_"))
    
    reformatted_df = do.call(rbind, mapply(function(qn, workerid_for_merge) {
      return(fromJSON(qn) %>% mutate(workerid=workerid_for_merge))
    }, raw_df$questions, raw_df$workerid, SIMPLIFY = F) %>% unname) 
    ## some versions collect reaction time, etc.:
    if (!("rt" %in% names(reformatted_df))) { reformatted_df$rt = NA }
    if (!("level" %in% names(reformatted_df))) { reformatted_df$level = NA }
    if (!("sigs" %in% names(reformatted_df))) { reformatted_df$sigs = NA }
    if (!("qNumber" %in% names(reformatted_df))) { reformatted_df$qNumber = NA }
    if ("qType" %in% names(reformatted_df)) { reformatted_df = reformatted_df%>%rename(qtype=qType) }
    if ("dollarAmt" %in% names(reformatted_df)) {
      reformatted_df = reformatted_df%>%rename(dollar_amount=dollarAmt)
    }
    if ("item" %in% names(reformatted_df)) {
      reformatted_df = reformatted_df%>%rename(object=item)
    }
    df = merge(
      raw_df %>% select(-questions),
      reformatted_df,
      by=c("workerid")
    ) %>%
      mutate(id = experiment_id,
             date = lookup_date(experiment_id))
    if (!("phrasing" %in% names(df))) { df$phrasing = NA }
    return(df)
  }
  df = do.call(rbind, lapply(c("00", "01", "07a", "07b", "07c", "10"), read_sorites_data)) %>%
    as.data.frame %>% flatten %>% ungroup %>% mutate(
    dollar_amount = as.numeric(unname(sapply(char(dollar_amount), function(money_string) {
      if (substr(money_string, 1, 1)=="$") {
        return(substr(money_string, start=2, stop=nchar(money_string)))
      } else {
        return(money_string)
      }
    }))),
    qtype = ifelse(qtype=="eps", "inductive", qtype),
    qtype = ifelse(qtype=="val", "concrete", qtype),
    qtype = factor(qtype),
    phrasing = ifelse(id %in% c("00", "01"), "relative", phrasing),
    response = num(response)
  )
  
  write.csv(df, "data/sorites/combined_reformatted_sorites_data.csv", row.names = F)
} else {
  df = read.csv("data/sorites/combined_reformatted_sorites_data.csv")
}
df = df %>% mutate(
  phrasing = ifelse(phrasing=='"relative"', "relative", phrasing),
  phrasing = ifelse(phrasing=='"conditional"', "conditional", phrasing),
  phrasing = factor(phrasing),
  id = factor(id)
)
```

```{r}
RUN_AGG = T
## computing confidence intervals takes a long time.
## so just cache the results of this most of the time
if (RUN_AGG) {
  agg = df %>%
  group_by(id, qtype, phrasing, object, dollar_amount) %>%
  summarise(low = ci.low(response),
            high = ci.high(response),
            response = mean(response))
write.csv(agg, "agg_cache.csv", row.names = F)
}  else {
agg = read.csv("agg_cache.csv")
}
```

```{r, fig.height=4, fig.width=12}
opacity = 0.5
agg %>% ggplot(., aes(x=dollar_amount, y=response, shape=id, colour=phrasing)) +
  geom_point(alpha=opacity) +
  # geom_line(alpha=opacity) +
  geom_errorbar(aes(ymin=low, ymax=high), width=0, alpha=opacity) +
  facet_grid(qtype~object, scale="free_x") +
  ylim(1, 9) +
  # scale_colour_brewer(type="qual", palette = 3) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggsave("sorites_data.png", width=12, height=4)
```






